name: Continuous Integration & Integration Tests

on:
  pull_request: # Kích hoạt khi có Pull Request
    branches: [main, dev]
  push:
    branches: [main, dev]

jobs:
  integration-test-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Build Ứng dụng Java (Tạo file JAR)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Build with Maven
        run: mvn clean install -DskipTests
        # Tên file JAR được tạo ra phải khớp với Dockerfile (target/my-java-app.jar)

      # 2. Build Docker Image Cục Bộ
      - name: Build Java App Docker Image (Local)
        # Sử dụng tag: my-java-app:test-image để khớp với docker-compose.yml
        run: docker build -t my-java-app:test-image .

      # 3. Khởi động môi trường Docker Compose (MongoDB + App)
      - name: Start Docker Compose Environment
        run: docker-compose up -d

      - name: Wait for services to be ready
        # Cần chờ một chút để các dịch vụ (đặc biệt là MongoDB) sẵn sàng
        uses: nev7n/wait_for_ports@v1
        with:
          # Kiểm tra cổng nội bộ của container (ví dụ: 27017)
          check_for_service: true
          host: localhost
          ports: '27017,8080' # Nếu 8080 là cổng ứng dụng Java

      # 4. Chạy Integration Tests (Kiểm tra tích hợp)
      # Giả định bạn đã cấu hình Maven để chạy các bài test kết nối DB (Integration Tests)
      - name: Run Integration Tests
        run: mvn verify
        # Hoặc lệnh chạy Test của bạn, ví dụ: mvn failsafe:integration-test

      # 5. Dọn dẹp môi trường tạm thời
      - name: Cleanup Docker Compose Environment
        if: always() # Luôn chạy bước này dù các bước trước đó thành công hay thất bại
        run: docker-compose down